name: convert

on:
  schedule:
    - cron: '0 7,15 * * *'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  convert:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: main # 显式指定主分支

      - name: Download Sources
        run: |
          curl -fsSL -o reward.txt https://edge.microsoft.com/abusiveadblocking/api/v1/blocklist
          if [ -n "${{ secrets.ALL_SOURCE }}" ]; then
            curl -fsSL -o all.txt "${{ secrets.ALL_SOURCE }}"
          fi

      - name: Extract to Adblock Format
        run: |
          mkdir -p scripts
          # 运行 Python 脚本进行 JSON 提取和 Adblock 转换
          python3 scripts/extract.py reward.txt domains.txt
          if [ -f all.txt ]; then
            python3 scripts/extract.py all.txt all_domains.txt
          fi

      - name: Check for Changes & Commit
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "Auto-update: Adblock rules [$(date +'%Y-%m-%d %H:%M')]"
          file_pattern: "*.txt"
          branch: main # 确保推送到正确的分支
