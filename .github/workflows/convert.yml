name: convert

on:
  schedule:
    - cron: '0 7,15 * * *'
  workflow_dispatch:

# 核心：必须赋予 Actions 写入权限，否则最后一步提交会失败
permissions:
  contents: write

jobs:
  convert:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download Sources
        run: |
          # [span_0](start_span)下载微软的 blocklist[span_0](end_span)
          curl -fsSL -o reward.txt https://edge.microsoft.com/abusiveadblocking/api/v1/blocklist
          # [span_1](start_span)如果配置了 ALL_SOURCE 变量，则下载对应的文件[span_1](end_span)
          if [ -n "${{ secrets.ALL_SOURCE }}" ]; then
            curl -fsSL -o all.txt "${{ secrets.ALL_SOURCE }}"
          fi

      - name: Convert to Adblock Format
        run: |
          # 直接使用 shell 处理，不再依赖外部 scripts 文件夹中的 Python 脚本
          # 这样可以避免 "file not found" 导致的报错
          
          process_adblock() {
            local input=$1
            local output="${input%.txt}_adblock.txt"
            echo "! Title: Adblock Rules for $input" > "$output"
            echo "! Last Updated: $(date +'%Y-%m-%d %H:%M')" >> "$output"
            
            # [span_2](start_span)过滤注释和空行[span_2](end_span)
            # [span_3](start_span)提取第二列域名[span_3](end_span)
            # [span_4](start_span)转换为 ||domain.com^ 格式[span_4](end_span)
            grep -vE '^#|^$|^\[' "$input" | awk '{print "||" $2 "^"}' | sort -u >> "$output"
          }

          [ -f reward.txt ] && process_adblock reward.txt
          [ -f all.txt ] && process_adblock all.txt

      - name: Check for Changes & Commit
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "Auto-update: Adblock format lists [$(date +'%Y-%m-%d %H:%M')]"
          file_pattern: "*.txt"
