name: convert

on:
  schedule:
    - cron: '0 7,15 * * *'
  workflow_dispatch:

jobs:
  convert:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download Sources
        run: |
          # 下载文件
          curl -fsSL -o reward.txt https://edge.microsoft.com/abusiveadblocking/api/v1/blocklist
          if [ -n "${{ secrets.ALL_SOURCE }}" ]; then
            curl -fsSL -o all.txt "${{ secrets.ALL_SOURCE }}"
          fi

      - name: Convert to YAML (Clash/Sing-box style)
        run: |
          generate_yaml() {
            local input=$1
            local output="${input%.txt}.yaml"
            echo "payload:" > "$output"
            # 提取域名并转换为 YAML 格式
            grep -vE '^#|^$|^\[' "$input" | awk '{print $2}' | sed '/^$/d' | sort -u | awk '{print "  - DOMAIN," $0}' >> "$output"
          }
          [ -f reward.txt ] && generate_yaml reward.txt
          [ -f all.txt ] && generate_yaml all.txt

      - name: Extract Clean Domains
        run: |
          # 运行我们存放在 scripts 文件夹里的脚本
          python3 scripts/extract.py reward.txt domains.txt

      - name: Check for Changes & Commit
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "Auto-update: Hosts and Domain list [$(date +'%Y-%m-%d %H:%M')]"
          file_pattern: "*.txt *.yaml"
          # 如果文件没有变化，Action 会自动跳过，无需手动写 if env.NEED_UPDATE
